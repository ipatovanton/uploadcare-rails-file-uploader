<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Uploadcare File Uploader Test</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@v1/web/uc-file-uploader-regular.min.css">
</head>
<body>
  <h1>Uploadcare File Uploader API Test</h1>

  <h2>Test 1: Basic Uploader</h2>
  <uc-config ctx-name="test-uploader" pubkey="c0cd83d9a422cafc96bd"></uc-config>
  <uc-upload-ctx-provider ctx-name="test-uploader"></uc-upload-ctx-provider>
  <uc-file-uploader-regular ctx-name="test-uploader" class="uploadcare-uploader"></uc-file-uploader-regular>
  <input type="hidden" id="test-uploader-input" name="file">

  <h2>Test 2: Pre-populated Uploader (with existing file)</h2>
  <uc-config ctx-name="test-prepopulated" pubkey="c0cd83d9a422cafc96bd"></uc-config>
  <uc-upload-ctx-provider ctx-name="test-prepopulated"></uc-upload-ctx-provider>
  <uc-file-uploader-regular
    ctx-name="test-prepopulated"
    class="uploadcare-uploader"
    data-initial-value="https://ucarecdn.com/5fe62e44-0e6a-4dd4-be7a-9e4a4171b644/"></uc-file-uploader-regular>
  <input type="hidden" id="test-prepopulated-input" name="file_prepopulated">

  <h2>Test 3: Multiple Files</h2>
  <uc-config ctx-name="test-multiple" pubkey="c0cd83d9a422cafc96bd" multiple="true"></uc-config>
  <uc-upload-ctx-provider ctx-name="test-multiple"></uc-upload-ctx-provider>
  <uc-file-uploader-regular
    ctx-name="test-multiple"
    class="uploadcare-uploader"
    data-initial-value="https://ucarecdn.com/5fe62e44-0e6a-4dd4-be7a-9e4a4171b644/,https://ucarecdn.com/another-uuid/"></uc-file-uploader-regular>
  <input type="hidden" id="test-multiple-input" name="files_multiple">

  <h2>Debug Console</h2>
  <div id="debug" style="background: #f0f0f0; padding: 20px; font-family: monospace; white-space: pre-wrap;"></div>

  <h2>Manual Test Buttons</h2>
  <button onclick="testAPIImmediate()">Test API Immediately</button>
  <button onclick="testAPIDelayed()">Test API After 1s Delay</button>
  <button onclick="testAddFile()">Test Add File From CDN URL</button>
  <button onclick="inspectAPI()">Inspect API Object</button>
  <button onclick="inspectState()">Inspect Output State</button>

  <script type="module">
    import * as UC from "https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@v1/web/file-uploader.min.js";
    UC.defineComponents(UC);

    // Make UC available globally for testing
    window.UC = UC;

    const debug = document.getElementById('debug');

    function log(message) {
      console.log(message);
      debug.textContent += message + '\n';
    }

    window.log = log;

    log('=== Uploadcare File Uploader Test ===');
    log('UC loaded: ' + (typeof UC !== 'undefined'));

    // Test 1: API access immediately after script load
    window.testAPIImmediate = function() {
      log('\n--- Test: API Access Immediately ---');
      const ctxProvider = document.querySelector('uc-upload-ctx-provider[ctx-name="test-uploader"]');
      log('ctxProvider found: ' + !!ctxProvider);

      if (ctxProvider) {
        log('ctxProvider type: ' + ctxProvider.constructor.name);
        log('ctxProvider.getAPI exists: ' + (typeof ctxProvider.getAPI === 'function'));

        try {
          const api = ctxProvider.getAPI();
          log('API obtained: ' + !!api);
          if (api) {
            log('API type: ' + api.constructor.name);
            log('API methods: ' + Object.getOwnPropertyNames(Object.getPrototypeOf(api)).join(', '));
          }
        } catch (err) {
          log('ERROR getting API: ' + err.message);
        }
      }
    };

    // Test 2: API access after delay
    window.testAPIDelayed = function() {
      log('\n--- Test: API Access After 1s Delay ---');
      setTimeout(() => {
        const ctxProvider = document.querySelector('uc-upload-ctx-provider[ctx-name="test-uploader"]');
        log('ctxProvider found: ' + !!ctxProvider);

        if (ctxProvider) {
          try {
            const api = ctxProvider.getAPI();
            log('API obtained: ' + !!api);
            if (api) {
              log('API type: ' + api.constructor.name);
              log('API methods: ' + Object.getOwnPropertyNames(Object.getPrototypeOf(api)).join(', '));
            }
          } catch (err) {
            log('ERROR getting API: ' + err.message);
          }
        }
      }, 1000);
    };

    // Test 3: Add file from CDN URL
    window.testAddFile = function() {
      log('\n--- Test: Add File From CDN URL ---');
      const ctxProvider = document.querySelector('uc-upload-ctx-provider[ctx-name="test-prepopulated"]');
      const testUrl = 'https://ucarecdn.com/5fe62e44-0e6a-4dd4-be7a-9e4a4171b644/';

      if (ctxProvider) {
        try {
          const api = ctxProvider.getAPI();
          log('API obtained: ' + !!api);
          log('api.addFileFromCdnUrl exists: ' + (typeof api.addFileFromCdnUrl === 'function'));

          if (api.addFileFromCdnUrl) {
            log('Calling api.addFileFromCdnUrl("' + testUrl + '")...');
            api.addFileFromCdnUrl(testUrl);
            log('SUCCESS: File added');
          } else {
            log('ERROR: addFileFromCdnUrl method not found');
          }
        } catch (err) {
          log('ERROR: ' + err.message);
          log('Stack: ' + err.stack);
        }
      } else {
        log('ERROR: ctxProvider not found');
      }
    };

    // Test 4: Inspect API object
    window.inspectAPI = function() {
      log('\n--- Test: Inspect API Object ---');
      const ctxProvider = document.querySelector('uc-upload-ctx-provider[ctx-name="test-uploader"]');

      if (ctxProvider) {
        try {
          log('ctxProvider properties: ' + Object.keys(ctxProvider).join(', '));
          log('ctxProvider prototype: ' + Object.getOwnPropertyNames(Object.getPrototypeOf(ctxProvider)).join(', '));

          const api = ctxProvider.getAPI();
          if (api) {
            log('\nAPI properties: ' + Object.keys(api).join(', '));
            log('API prototype: ' + Object.getOwnPropertyNames(Object.getPrototypeOf(api)).join(', '));

            // Try to list all methods
            let proto = Object.getPrototypeOf(api);
            let methods = [];
            while (proto && proto !== Object.prototype) {
              methods = methods.concat(Object.getOwnPropertyNames(proto));
              proto = Object.getPrototypeOf(proto);
            }
            log('\nAll API methods (inheritance chain): ' + [...new Set(methods)].sort().join(', '));
          }
        } catch (err) {
          log('ERROR: ' + err.message);
        }
      }
    };

    // Test 5: Inspect output state
    window.inspectState = function() {
      log('\n--- Test: Inspect Output State ---');
      const ctxProvider = document.querySelector('uc-upload-ctx-provider[ctx-name="test-prepopulated"]');

      if (ctxProvider) {
        try {
          const api = ctxProvider.getAPI();
          const state = api.getOutputCollectionState();

          log('State type: ' + typeof state);
          log('State isArray: ' + Array.isArray(state));

          if (state) {
            log('State constructor: ' + state.constructor.name);
            if (typeof state === 'object') {
              log('State keys: ' + Object.keys(state).join(', '));
              log('\nState JSON: ' + JSON.stringify(state, null, 2));

              if (!Array.isArray(state)) {
                log('\nConverting to array with Object.values():');
                const values = Object.values(state);
                log('Values count: ' + values.length);
                log('Values: ' + JSON.stringify(values, null, 2));
              }
            }
          }
        } catch (err) {
          log('ERROR: ' + err.message);
          log('Stack: ' + err.stack);
        }
      }
    };

    // Wait for custom elements to be defined
    log('\n--- Waiting for Web Components to be defined ---');

    Promise.all([
      customElements.whenDefined('uc-config'),
      customElements.whenDefined('uc-upload-ctx-provider'),
      customElements.whenDefined('uc-file-uploader-regular')
    ]).then(() => {
      log('✓ All Web Components defined');

      // Wait a bit more for initialization
      setTimeout(() => {
        log('\n--- Auto-test after components ready ---');

        // Test pre-population
        const ctxProvider = document.querySelector('uc-upload-ctx-provider[ctx-name="test-prepopulated"]');
        const uploaderElement = document.querySelector('uc-file-uploader-regular[ctx-name="test-prepopulated"]');
        const initialValue = uploaderElement?.dataset?.initialValue;

        log('Pre-population test:');
        log('  Initial value: ' + initialValue);
        log('  ctxProvider: ' + !!ctxProvider);

        if (ctxProvider && initialValue) {
          try {
            const api = ctxProvider.getAPI();
            log('  API: ' + !!api);
            log('  addFileFromCdnUrl: ' + (typeof api?.addFileFromCdnUrl));

            if (api && api.addFileFromCdnUrl) {
              if (initialValue.includes(',')) {
                const urls = initialValue.split(',').map(u => u.trim()).filter(u => u);
                log('  Adding ' + urls.length + ' files...');
                urls.forEach(url => {
                  api.addFileFromCdnUrl(url);
                  log('    ✓ Added: ' + url);
                });
              } else {
                log('  Adding single file...');
                api.addFileFromCdnUrl(initialValue);
                log('    ✓ Added: ' + initialValue);
              }
            } else {
              log('  ✗ addFileFromCdnUrl not available');
            }
          } catch (err) {
            log('  ✗ ERROR: ' + err.message);
          }
        }

        // Setup event listeners
        const setupEvents = (ctxName, inputId) => {
          const provider = document.querySelector(`uc-upload-ctx-provider[ctx-name="${ctxName}"]`);
          const input = document.getElementById(inputId);

          if (!provider || !input) return;

          const updateInput = () => {
            try {
              const api = provider.getAPI();
              const state = api.getOutputCollectionState?.() || [];

              // Debug: log state structure
              log(`[${ctxName}] State type: ${typeof state}, isArray: ${Array.isArray(state)}`);
              if (typeof state === 'object' && !Array.isArray(state)) {
                log(`[${ctxName}] State keys: ${Object.keys(state).join(', ')}`);
              }

              // Handle both array and object formats
              let successFiles = [];
              if (Array.isArray(state)) {
                successFiles = state.filter(f => f.status === 'success');
              } else if (typeof state === 'object' && state !== null) {
                // State might be an object with file IDs as keys
                successFiles = Object.values(state).filter(f => f && f.status === 'success');
              }

              if (successFiles.length === 0) {
                input.value = '';
              } else {
                input.value = successFiles.map(f => f.cdnUrl).join(',');
              }

              log(`[${ctxName}] Input updated: ${input.value}`);
            } catch (err) {
              log(`[${ctxName}] Error updating input: ${err.message}`);
            }
          };

          provider.addEventListener('file-upload-success', (e) => {
            log(`[${ctxName}] file-upload-success: ${JSON.stringify(e.detail)}`);
            updateInput();
          });

          provider.addEventListener('file-removed', (e) => {
            log(`[${ctxName}] file-removed: ${JSON.stringify(e.detail)}`);
            updateInput();
          });

          provider.addEventListener('change', (e) => {
            log(`[${ctxName}] change`);
            updateInput();
          });
        };

        setupEvents('test-uploader', 'test-uploader-input');
        setupEvents('test-prepopulated', 'test-prepopulated-input');
        setupEvents('test-multiple', 'test-multiple-input');

        log('\n✓ Event listeners setup complete');
        log('\n=== Ready for testing ===');
      }, 500);
    }).catch(err => {
      log('ERROR waiting for components: ' + err.message);
    });
  </script>
</body>
</html>
